# Design System Builder Plugin - Developer Guide

## Table of Contents
1. [Project Overview](#project-overview)
2. [Architecture & Design Decisions](#architecture--design-decisions)
3. [Codebase Structure](#codebase-structure)
4. [How to Add a New Feature](#how-to-add-a-new-feature)
5. [Variable Binding Implementation](#variable-binding-implementation)
6. [Git Workflow](#git-workflow)
7. [Deployment](#deployment)
8. [Common Tasks](#common-tasks)
9. [Code Style & Conventions](#code-style--conventions)
10. [Resources](#resources)

---

## Project Overview

### Purpose and Goals

The Design System Builder is a Figma plugin that automates the creation of icon components with design system integration. It reduces manual work for designers creating icon systems and ensures consistency through variable binding.

**Key Goals**:
- Streamline icon component creation
- Integrate with design system variables
- Support both batch and single-mode workflows
- Maintain clean, extensible code architecture

### Current Features

- **Icon Set Builder**: Creates 7-size icon variants (12-48px) with optimized stroke weights
- **Single Icon Builder**: Creates individual 24px icon components
- **Variable Binding**: Automatically binds component dimensions to Figma size variables
- **Batch Processing**: Create multiple components in one workflow
- **Component Set Management**: Combines variants into professional component sets

### Technology Stack

- **TypeScript**: Type-safe plugin development
- **Figma Plugin API**: Direct integration with Figma
- **Vercel**: Deployment platform (optional, for extended features like feedback)
- **SendGrid**: Email integration (optional, feature branch only)

---

## Architecture & Design Decisions

### Why TypeScript for Plugin Development

TypeScript provides several benefits for Figma plugin development:
- **Type Safety**: Figma's API is complex; TypeScript prevents type-related bugs
- **Autocomplete**: IDE support makes it easier to discover API methods
- **Refactoring**: Safe refactoring with type checking
- **Maintenance**: Code is self-documenting and easier to maintain

### Component Structure Philosophy

The plugin follows a modular architecture:

```
code.ts (Main handler/router)
    ↓
iconSet.ts / iconSingle.ts (Feature implementations)
    ↓
iconUtils.ts (Shared utilities)
    ↓
shared.ts (Validation & helpers)
```

**Benefits**:
- Each builder has its own file for clarity
- Shared utilities avoid code duplication
- Easy to add new builders without touching existing code

### Variable Binding Approach

Variables are looked up by their full path (`Icon size/24`) rather than by ID:

**Why**:
- More human-readable and maintainable
- Variables are accessed by collection path format
- Makes it easier to understand what variable is being bound

**How it works**:
```typescript
// Get all local variables
const variables = await figma.variables.getLocalVariablesAsync();

// Search by full path
const variablePath = `Icon size/${size}`; // e.g., "Icon size/24"
for (const variable of variables) {
  if (variable.name === variablePath) {
    // Found it, bind to component
    component.setBoundVariable('width', variable);
  }
}
```

### File Organization Rationale

- **code.ts**: Single responsibility - route messages
- **iconSet.ts / iconSingle.ts**: Feature-specific logic, testable independently
- **iconUtils.ts**: Utilities that are shared (component creation, styling)
- **shared.ts**: Cross-cutting concerns (validation, types)
- **ui.html**: All UI in one file for easier updates

### Git Branching Strategy

- **main**: Stable production-ready code with core features
- **feature/\***: Experimental features (e.g., feedback improvements)

Keep main branch deployable at all times.

---

## Codebase Structure

```
/project-root
├── code.ts                 - Main plugin handler & message routing (~200 lines)
├── code.js                 - Compiled output (generated by build)
├── ui.html                 - Plugin UI, all screens (~1000+ lines)
├── iconSet.ts              - Icon Set builder implementation (~200 lines)
├── iconSingle.ts           - Single Icon builder implementation (~150 lines)
├── iconUtils.ts            - Shared utilities (~280 lines)
├── shared.ts               - Validation & helpers (~80 lines)
├── manifest.json           - Plugin metadata
├── package.json            - Dependencies & build scripts
├── tsconfig.json           - TypeScript configuration
├── Streamline Regular/     - Icon library (9,416 icons)
├── DOCUMENTATION_PLAN.md   - Documentation outline
├── USER_GUIDE.md           - User documentation
├── DEVELOPER_GUIDE.md      - This file
└── vercel.json             - Vercel deployment config (optional)
```

---

## File Details and Responsibilities

### code.ts (~200 lines)

**Purpose**: Main plugin entry point that routes messages between UI and builder functions.

**Key Responsibilities**:
- Listen for messages from UI
- Route messages to appropriate builder functions
- Manage Figma API interactions
- Handle success/error responses

**Message Types**:
- `create-icon-set`: Trigger Icon Set builder
- `create-icon-single`: Trigger Single Icon builder

**Example Message Handler**:
```typescript
if (msg.type === 'create-icon-set') {
  const selectedNode = figma.currentPage.selection[0];
  if (selectedNode) {
    try {
      await createIconSet(selectedNode, msg.iconName, msg.yPosition, msg.xPosition);
      figma.ui.postMessage({
        type: 'create-icon-set',
        success: true
      });
    } catch (error) {
      figma.ui.postMessage({
        type: 'create-icon-set',
        success: false,
        error: error.message
      });
    }
  }
}
```

### ui.html (~1000+ lines)

**Purpose**: Complete plugin UI with all screens, styles, and interactions.

**Key Sections**:
1. **Landing Screen**: Displays builder tiles
2. **Icon Set Builder View**: Single/batch mode UI
3. **Single Icon Builder View**: Single/batch mode UI
4. **CSS Styling**: All visual styles for components
5. **JavaScript**: Event handlers and UI logic

**Key Functions**:
- `showLandingScreen()`: Display main screen
- `showIconSetView()`: Display Icon Set builder
- `showIconSingleView()`: Display Single Icon builder
- `postMessageToPlugin()`: Send messages to code.ts

### iconSet.ts (~200 lines)

**Purpose**: Icon Set builder - creates component sets with 7 size variants.

**Key Functions**:

```typescript
export async function createIconSet(
  sourceNode: BaseNode,
  iconName: string,
  yPosition?: number,
  xPosition?: number
): Promise<void>
```

Creates a single icon set with 7 sizes (12, 16, 20, 24, 32, 40, 48px).

```typescript
export async function processBatch(
  selectedNodes: readonly BaseNode[]
): Promise<BuilderResult>
```

Creates multiple icon sets from selected frames (batch mode).

**Size Mapping**:
```typescript
const SIZES_AND_WEIGHTS: { [key: number]: number } = {
  12: 1,
  16: 1.25,
  20: 1.5,
  24: 2,
  32: 2.5,
  40: 3,
  48: 3.5
};
```

Each size has an optimized stroke weight for visual consistency.

### iconSingle.ts (~150 lines)

**Purpose**: Single Icon builder - creates individual 24px components.

**Key Functions**:

```typescript
export async function createIconSingle(
  sourceNode: BaseNode,
  iconName: string,
  yPosition?: number,
  xPosition?: number
): Promise<void>
```

Creates a single 24px component.

```typescript
export async function processBatchSingle(
  selectedNodes: readonly BaseNode[]
): Promise<BuilderResult>
```

Creates multiple 24px components from selected frames.

**Constants**:
```typescript
const ICON_SIZE = 24;
const STROKE_WEIGHT = 2;
```

### iconUtils.ts (~280 lines)

**Purpose**: Shared utilities for component creation, styling, and variable binding.

**Key Functions**:

```typescript
export async function createIconComponent(
  iconClone: BaseNode,
  size: number,
  strokeWeight: number,
  originalWidth: number,
  originalHeight: number
): Promise<ComponentNode>
```

Core function that creates a component at a specific size:
1. Resizes icon to target size
2. Applies 83% scaling to prevent stroke cutoff
3. Applies stroke weight
4. Creates frame and component
5. **Binds to size variable** (e.g., `Icon size/24`)
6. Centers icon in frame

**Variable Binding Details**:
```typescript
async function getVariable(size: number): Promise<Variable | null> {
  const variables = await figma.variables.getLocalVariablesAsync();
  const variablePath = `Icon size/${size}`;

  for (const variable of variables) {
    if (variable.name === variablePath) {
      return variable;
    }
  }
  return null;
}
```

Other Important Functions:
- `applyStrokeWeightRecursive()`: Recursively applies stroke weight to all vectors
- `centerComponentsInFrame()`: Centers components within a component set
- `styleComponentSet()`: Applies visual styling (dashed border, padding)
- `setComponentConstraints()`: Sets up component constraints for responsiveness

### shared.ts (~80 lines)

**Purpose**: Cross-cutting concerns and shared validation.

**Key Functions**:

```typescript
export function validateAndExtractWorkingFrame(sourceNode: BaseNode) {
  // Validates frame, extracts vector content, handles nested structures
  return {
    workingFrame: FrameNode,
    vectors: VectorNode[],
    originalWidth: number,
    originalHeight: number
  };
}

export function isValidName(name: string): boolean {
  // Checks for invalid characters in component names
  // Disallows: /, :, !, ?, *
}
```

**Type Definitions**:
```typescript
export interface BuilderResult {
  message: string;
  isError?: boolean;
}
```

---

## How to Add a New Feature

### Example: Add a "Batch Badge Builder"

#### Step 1: Create Feature File

Create `/badgeBuilder.ts`:

```typescript
import {
  createIconComponent,
  centerComponentsInFrame,
  styleComponentSet
} from './iconUtils';
import { validateAndExtractWorkingFrame, isValidName, BuilderResult } from './shared';

const BADGE_SIZE = 16;
const BADGE_STROKE_WEIGHT = 1;

export async function createBadge(
  sourceNode: BaseNode,
  badgeName: string,
  yPosition?: number,
  xPosition?: number
): Promise<void> {
  // Implementation similar to iconSingle.ts
}

export async function processBatchBadge(
  selectedNodes: readonly BaseNode[]
): Promise<BuilderResult> {
  // Validate all names first
  // Then process each frame
  // Return success/failure message
}
```

#### Step 2: Update code.ts

Add message handler:

```typescript
import { createBadge, processBatchBadge } from './badgeBuilder';

if (msg.type === 'create-badge') {
  const result = await processBatchBadge(figma.currentPage.selection);
  figma.ui.postMessage({ type: 'create-badge', result });
}
```

#### Step 3: Update ui.html

Add UI elements:

```html
<!-- Add to landing screen -->
<div class="builder-tile">
  <svg class="builder-icon"><!-- badge icon --></svg>
  <h3>Badge Builder</h3>
  <p>Create badge components</p>
</div>

<!-- Add builder view -->
<div id="badgeView" class="builder-view" style="display: none;">
  <button class="back-button">← Back</button>
  <h2>Badge Builder</h2>
  <input type="text" id="badgeName" placeholder="Badge name">
  <button id="createBadgeBtn">Create Badge</button>
</div>

<!-- Add JavaScript -->
<script>
  document.getElementById('createBadgeBtn').addEventListener('click', () => {
    const badgeName = document.getElementById('badgeName').value;
    postMessageToPlugin({ type: 'create-badge', badgeName });
  });
</script>
```

#### Step 4: Create Feature Branch

```bash
git checkout -b feature/badge-builder
git add .
git commit -m "Add Badge Builder feature"
git push origin feature/badge-builder
```

#### Step 5: Test and Merge

1. Test thoroughly in Figma
2. Create a pull request
3. Code review
4. Merge to main when ready

---

## Variable Binding Implementation

### How Size Variables Work

**Location**: `iconUtils.ts` - `getVariable()` and `createIconComponent()` functions

**Variable Path Format**: `Icon size/{size}`
- Examples: `Icon size/12`, `Icon size/24`, `Icon size/48`

**Binding Process**:
```typescript
const variable = await getVariable(size); // Find variable by path

if (variable) {
  // Bind width and height to the variable
  component.setBoundVariable('width', variable);
  component.setBoundVariable('height', variable);

  console.log(`✓ Bound component to Icon size/${size} variable`);
}
```

**Important**: Use Variable object, not variable ID. The older API with IDs is deprecated.

### Creating or Modifying Variables

To add new size variables:

1. **In Figma File**:
   - Assets → Variables → Create collection "Icon size"
   - Add variables: `Icon size/12`, `Icon size/16`, etc.
   - Set each variable's value to its size (e.g., 24)

2. **In Plugin Code** (if changing variable path):
   - Edit `getVariable()` function in `iconUtils.ts`
   - Change `Icon size/` prefix if needed
   - Update `SIZES_AND_WEIGHTS` in `iconSet.ts` if adding/removing sizes

### Example: Change Variable Naming

If you want to use `Component sizes/24` instead of `Icon size/24`:

```typescript
// In iconUtils.ts, modify getVariable():
async function getVariable(size: number): Promise<Variable | null> {
  const variables = await figma.variables.getLocalVariablesAsync();
  const variablePath = `Component sizes/${size}`; // Changed from "Icon size"

  for (const variable of variables) {
    if (variable.name === variablePath) {
      return variable;
    }
  }
  return null;
}
```

---

## Git Workflow

### Main Branch Principles

- Always deployable and production-ready
- Contains only stable, tested code
- Core features only (Icon Set, Single Icon builders)

### Feature Branch Workflow

**Creating a Feature Branch**:
```bash
git checkout main
git pull origin main
git checkout -b feature/your-feature-name

# Make changes
git add .
git commit -m "Description of changes"
git push origin feature/your-feature-name
```

**Creating a Pull Request**:
1. Push feature branch to GitHub
2. Open PR with description of changes
3. Include testing steps
4. Request code review
5. Address feedback
6. Merge when approved

**Merging to Main**:
```bash
git checkout main
git pull origin main
git merge feature/your-feature-name
git push origin main
```

### Branch Examples

- `feature/feedback-improvements`: Feedback form with email integration (separate branch)
- `feature/badge-builder`: New badge component builder
- `feature/improved-ui`: UI enhancements

---

## Deployment

### Local Development

**Setup**:
```bash
npm install
npm run build
```

**Testing in Figma**:
1. In Figma, go to Plugins → Design plugins → Development
2. Click "Create plugin"
3. Point manifest to your local `manifest.json`
4. Test changes in real Figma files

### Building for Release

**Build TypeScript**:
```bash
npm run build
```

This compiles TypeScript to `code.js`.

**Commit and Push**:
```bash
git add code.js
git commit -m "Build for release"
git push origin main
```

### Publishing to Figma Community

1. Build the plugin: `npm run build`
2. Go to Figma Plugin Library
3. Create plugin listing
4. Upload manifest and code.js
5. Publish for community access

### Vercel Deployment (Optional - Feature Branches)

For features that need backend support (like feedback with email):

```bash
vercel --prod
```

Requires environment variables:
- `SENDGRID_API_KEY`
- `RECIPIENT_EMAIL`

See feature branch documentation for details.

---

## Common Tasks

### Modify Size Variants

Edit `SIZES_AND_WEIGHTS` in `iconSet.ts`:

```typescript
const SIZES_AND_WEIGHTS: { [key: number]: number } = {
  12: 1,
  16: 1.25,
  20: 1.5,
  24: 2,
  32: 2.5,
  40: 3,
  48: 3.5
  // Add or modify sizes here
};
```

Then update `createIconSet()` to handle new sizes.

### Change Stroke Weight Formula

Modify `applyStrokeWeightRecursive()` in `iconUtils.ts`:

```typescript
export function applyStrokeWeightRecursive(node: BaseNode, weight: number): void {
  if ('strokeWeight' in node) {
    (node as any).strokeWeight = weight; // Change formula here if needed
  }
  // ... recursively apply to children
}
```

### Update Component Styling

Edit `styleComponentSet()` in `iconUtils.ts`:

```typescript
export function styleComponentSet(componentSet: ComponentSetNode): void {
  // Change stroke color (currently 9747FF - purple)
  const stroke: Paint = {
    type: 'SOLID',
    color: { r: 0.59, g: 0.28, b: 1.0 }, // Change RGB values
    opacity: 1
  };

  // Change stroke weight, dash pattern, padding, etc.
  componentSetAny.strokeWeight = 1; // Change here
  componentSetAny.strokeDashPattern = [10, 5]; // Change dash/gap
  componentSetAny.paddingLeft = 16; // Change padding
}
```

### Add UI Elements

Edit `ui.html`:

```html
<!-- Add new tile -->
<div class="builder-tile">
  <svg class="builder-icon"><!-- icon --></svg>
  <h3>New Feature</h3>
  <p>Description</p>
</div>

<!-- Add new view -->
<div id="newFeatureView" class="builder-view">
  <!-- UI elements here -->
</div>

<!-- Add styles -->
<style>
  #newFeatureView { /* styling */ }
</style>

<!-- Add JavaScript -->
<script>
  document.getElementById('newFeatureBtn').addEventListener('click', () => {
    // Handle click
  });
</script>
```

---

## Code Style & Conventions

### Naming Conventions

- **Functions**: `camelCase` (e.g., `createIconComponent`)
- **Types/Interfaces**: `PascalCase` (e.g., `BuilderResult`)
- **Constants**: `UPPER_SNAKE_CASE` (e.g., `COMPONENT_SET_WIDTH`)
- **Variables**: `camelCase` (e.g., `iconName`)

### Comments

Explain the "why", not the "what":

```typescript
// Good: Explains reasoning
// Resize to 83% to prevent stroke cutoff at small sizes
(iconClone as any).resize(scaledSize83Width, scaledSize83Height);

// Avoid: Just restates code
// Set strokeWeight to weight
node.strokeWeight = weight;
```

### Error Handling

Always wrap async operations:

```typescript
try {
  const component = await createIconComponent(...);
  // Use component
} catch (error) {
  const message = error instanceof Error ? error.message : 'Unknown error';
  console.error('Failed to create component:', message);
  // Handle error appropriately
}
```

### Logging

Use console for debugging, remove before merging:

```typescript
console.log('Creating icon at size:', size); // OK during development
console.error('Variable binding failed:', error); // Keep for important errors
```

### JSDoc Comments

Document exported functions:

```typescript
/**
 * Creates a component frame for an icon at a specific size
 * @param iconClone - The cloned icon node
 * @param size - Target size in pixels (12-48)
 * @param strokeWeight - Stroke weight to apply
 * @returns The created component node
 */
export async function createIconComponent(
  iconClone: BaseNode,
  size: number,
  strokeWeight: number,
  originalWidth: number,
  originalHeight: number
): Promise<ComponentNode> {
  // Implementation
}
```

---

## Testing Checklist

Before merging to main:

- [ ] Single mode Icon Set creates components correctly
- [ ] Batch mode Icon Set processes multiple frames
- [ ] Single mode Single Icon creates 24px component
- [ ] Batch mode Single Icon stacks components vertically
- [ ] Size variables bind correctly (check console logs)
- [ ] Component naming follows conventions
- [ ] Components are centered in frames
- [ ] No console errors
- [ ] UI is responsive and clickable
- [ ] Back button navigation works
- [ ] Error messages display correctly
- [ ] Tested with various icon designs
- [ ] Tested with batch sizes (10+ frames)

---

## Resources

- [Figma Plugin API Documentation](https://www.figma.com/plugin-docs/)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [Figma Variables Guide](https://www.figma.com/plugin-docs/variables/)
- [Component Sets Documentation](https://www.figma.com/plugin-docs/component-sets/)
- [Vercel Functions Documentation](https://vercel.com/docs/functions)
- [SendGrid Email API](https://docs.sendgrid.com/api-reference/mail-send/mail-send)

---

## Future Enhancement Ideas

- [ ] Color style binding to design system colors
- [ ] Custom stroke weight presets per project
- [ ] Icon animation support
- [ ] Batch export to SVG
- [ ] Icon search/filter interface in plugin
- [ ] Template-based icon creation
- [ ] Analytics dashboard for icon usage
- [ ] Multi-file library support
- [ ] Icon auto-naming based on file content
- [ ] Accessibility validation for icons

---

**Last Updated**: November 2024
**Plugin Version**: 1.0
**Maintained By**: Design System Team
